{"version":3,"file":"SymbolCache.js","names":["ts","_interopRequireWildcard","require","_TypeScriptLinterConfig","_ForEachNodeInSubtree","_IsStruct","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_newArrowCheck","TypeError","_defineProperty","_toPropertyKey","value","enumerable","configurable","writable","_toPrimitive","Symbol","toPrimitive","String","Number","SymbolCache","constructor","typeChecker","utils","sourceFile","cancellationToken","_this","Map","SyntaxKind","ElementAccessExpression","handleElementAccessExpression","EnumDeclaration","handleEnumDeclaration","PrivateIdentifier","handlePrivateIdentifier","PropertyAssignment","handlePropertyAssignment","PropertyDeclaration","handlePropertyDeclaration","PropertySignature","handlePropertySignature","FunctionDeclaration","handleFunctionDeclaration","CallExpression","handleCallExpression","Identifier","handleIdentifier","callback","node","isStructDeclaration","throwIfCancellationRequested","symbol","handlersMap","kind","undefined","addReference","bind","stopCondition","LinterConfig","terminalTokens","forEachNodeInSubtree","getReferences","cache","elementAccessExpr","getSymbolAtLocation","argumentExpression","enumDeclaration","trueSymbolAtLocation","name","privateIdentifier","propertyAssignment","contextualType","getContextualType","parent","getPropertySymbol","propertyDeclaration","propertySignature","functionDeclaration","callExpression","expression","identifier","flags","SymbolFlags","Variable","nodes","push","exports"],"sources":["../../../lib/autofixes/SymbolCache.ts"],"sourcesContent":["/*\n * Copyright (c) 2022-2024 Huawei Device Co., Ltd.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as ts from 'typescript';\nimport { LinterConfig } from '../TypeScriptLinterConfig';\nimport { forEachNodeInSubtree } from '../utils/functions/ForEachNodeInSubtree';\nimport { isStructDeclaration } from '../utils/functions/IsStruct';\nimport type { TsUtils } from '../utils/TsUtils';\n\nexport class SymbolCache {\n  constructor(\n    private readonly typeChecker: ts.TypeChecker,\n    private readonly utils: TsUtils,\n    readonly sourceFile: ts.SourceFile,\n    readonly cancellationToken?: ts.CancellationToken\n  ) {\n    const callback = (node: ts.Node): void => {\n      if (isStructDeclaration(node)) {\n        // early exit via exception if cancellation was requested\n        this.cancellationToken?.throwIfCancellationRequested();\n      }\n\n      const symbol = this.handlersMap.get(node.kind)?.call(this, node);\n      if (symbol !== undefined) {\n        this.addReference(symbol, node);\n      }\n    };\n\n    const stopCondition = (node: ts.Node): boolean => {\n      return !node || LinterConfig.terminalTokens.has(node.kind);\n    };\n\n    forEachNodeInSubtree(sourceFile, callback, stopCondition);\n  }\n\n  getReferences(symbol: ts.Symbol): ts.Node[] {\n    return this.cache.get(symbol) ?? [];\n  }\n\n  private handleElementAccessExpression(node: ts.Node): ts.Symbol | undefined {\n    const elementAccessExpr = node as ts.ElementAccessExpression;\n    return this.typeChecker.getSymbolAtLocation(elementAccessExpr.argumentExpression);\n  }\n\n  private handleEnumDeclaration(node: ts.Node): ts.Symbol | undefined {\n    const enumDeclaration = node as ts.EnumDeclaration;\n    return this.utils.trueSymbolAtLocation(enumDeclaration.name);\n  }\n\n  private handlePrivateIdentifier(node: ts.Node): ts.Symbol | undefined {\n    const privateIdentifier = node as ts.PrivateIdentifier;\n    return this.typeChecker.getSymbolAtLocation(privateIdentifier);\n  }\n\n  private handlePropertyAssignment(node: ts.Node): ts.Symbol | undefined {\n    const propertyAssignment = node as ts.PropertyAssignment;\n    const contextualType = this.typeChecker.getContextualType(propertyAssignment.parent);\n    return contextualType === undefined ? undefined : this.utils.getPropertySymbol(contextualType, propertyAssignment);\n  }\n\n  private handlePropertyDeclaration(node: ts.Node): ts.Symbol | undefined {\n    const propertyDeclaration = node as ts.PropertyDeclaration;\n    return this.typeChecker.getSymbolAtLocation(propertyDeclaration.name);\n  }\n\n  private handlePropertySignature(node: ts.Node): ts.Symbol | undefined {\n    const propertySignature = node as ts.PropertySignature;\n    return this.typeChecker.getSymbolAtLocation(propertySignature.name);\n  }\n\n  private handleFunctionDeclaration(node: ts.Node): ts.Symbol | undefined {\n    const functionDeclaration = node as ts.FunctionDeclaration;\n    return functionDeclaration.name ? this.typeChecker.getSymbolAtLocation(functionDeclaration.name) : undefined;\n  }\n\n  private handleCallExpression(node: ts.Node): ts.Symbol | undefined {\n    const callExpression = node as ts.CallExpression;\n    return this.typeChecker.getSymbolAtLocation(callExpression.expression);\n  }\n\n  private handleIdentifier(node: ts.Node): ts.Symbol | undefined {\n    const identifier = node as ts.Identifier;\n    const symbol = this.typeChecker.getSymbolAtLocation(identifier);\n    if (symbol?.flags) {\n      return (symbol.flags & ts.SymbolFlags.Variable) !== 0 ? symbol : undefined;\n    }\n    return undefined;\n  }\n\n  private addReference(symbol: ts.Symbol, node: ts.Node): void {\n    let nodes = this.cache.get(symbol);\n    if (nodes === undefined) {\n      nodes = [];\n      this.cache.set(symbol, nodes);\n    }\n    nodes.push(node);\n  }\n\n  private readonly handlersMap = new Map([\n    [ts.SyntaxKind.ElementAccessExpression, this.handleElementAccessExpression],\n    [ts.SyntaxKind.EnumDeclaration, this.handleEnumDeclaration],\n    [ts.SyntaxKind.PrivateIdentifier, this.handlePrivateIdentifier],\n    [ts.SyntaxKind.PropertyAssignment, this.handlePropertyAssignment],\n    [ts.SyntaxKind.PropertyDeclaration, this.handlePropertyDeclaration],\n    [ts.SyntaxKind.PropertySignature, this.handlePropertySignature],\n    [ts.SyntaxKind.FunctionDeclaration, this.handleFunctionDeclaration],\n    [ts.SyntaxKind.CallExpression, this.handleCallExpression],\n    [ts.SyntaxKind.Identifier, this.handleIdentifier]\n  ]);\n\n  private readonly cache: Map<ts.Symbol, ts.Node[]> = new Map<ts.Symbol, ts.Node[]>();\n}\n"],"mappings":"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","ignoreList":[]}