{"version":3,"file":"TSCCompiledProgram.js","names":["ts","_interopRequireWildcard","require","_ProblemSeverity","_TypeScriptDiagnosticsExtractor","_Problems","_FaultAttrs","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_newArrowCheck","TypeError","_defineProperty","_toPropertyKey","value","enumerable","configurable","writable","_toPrimitive","Symbol","toPrimitive","String","Number","TSCCompiledProgramSimple","constructor","program","getProgram","getStrictDiagnostics","fileName","exports","TSCCompiledProgramWithDiagnostics","strict","nonStrict","inputFiles","cancellationToken","progressCb","_this","Map","forEach","sourceFile","getSourceFile","undefined","cachedDiagnostics","bind","transformDiagnostic","diagnostic","startPos","start","getLineAndColumn","file","endPos","length","end","messageText","flattenDiagnosticMessageText","faultId","FaultID","StrictDiagnostic","line","column","endLine","endColumn","type","severity","ProblemSeverity","ERROR","problem","suggest","rule","ruleTag","faultsAttrs","cookBookRef","position","character","getLineAndCharacterOfPosition"],"sources":["../../../lib/ts-diagnostics/TSCCompiledProgram.ts"],"sourcesContent":["/*\n * Copyright (c) 2023-2024 Huawei Device Co., Ltd.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as ts from 'typescript';\nimport type { ProblemInfo } from '../ProblemInfo';\nimport { ProblemSeverity } from '../ProblemSeverity';\nimport { getStrictDiagnostics } from './TypeScriptDiagnosticsExtractor';\nimport { FaultID } from '../Problems';\nimport { faultsAttrs } from '../FaultAttrs';\n\nexport interface TSCCompiledProgram {\n  getProgram: () => ts.Program;\n  getStrictDiagnostics: (fileName: string) => ts.Diagnostic[];\n}\n\nexport class TSCCompiledProgramSimple implements TSCCompiledProgram {\n  private readonly program: ts.Program;\n\n  constructor(program: ts.Program) {\n    this.program = program;\n  }\n\n  getProgram(): ts.Program {\n    return this.program;\n  }\n\n  getStrictDiagnostics(fileName: string): ts.Diagnostic[] {\n    void this;\n    void fileName;\n    return [];\n  }\n}\n\nexport type ProgressCallback = (message: string) => void;\n\nexport class TSCCompiledProgramWithDiagnostics implements TSCCompiledProgram {\n  private readonly program: ts.Program;\n  private readonly cachedDiagnostics: Map<string, ts.Diagnostic[]> = new Map();\n\n  constructor(\n    strict: ts.Program,\n    nonStrict: ts.Program,\n    inputFiles: string[],\n    cancellationToken?: ts.CancellationToken,\n    progressCb?: ProgressCallback\n  ) {\n    this.program = strict;\n\n    inputFiles.forEach((fileName) => {\n      progressCb?.(fileName);\n\n      const sourceFile = this.program.getSourceFile(fileName);\n      if (sourceFile !== undefined) {\n        this.cachedDiagnostics.set(\n          sourceFile.fileName,\n          getStrictDiagnostics(strict, nonStrict, sourceFile.fileName, cancellationToken)\n        );\n      }\n    });\n  }\n\n  getProgram(): ts.Program {\n    return this.program;\n  }\n\n  getStrictDiagnostics(fileName: string): ts.Diagnostic[] {\n    return this.cachedDiagnostics.get(fileName) ?? [];\n  }\n}\n\nexport function transformDiagnostic(diagnostic: ts.Diagnostic): ProblemInfo {\n  const startPos = diagnostic.start!;\n  const start = getLineAndColumn(diagnostic.file!, startPos);\n  const endPos = startPos + diagnostic.length!;\n  const end = getLineAndColumn(diagnostic.file!, endPos);\n  const messageText = ts.flattenDiagnosticMessageText(diagnostic.messageText, '\\n');\n  const faultId = FaultID.StrictDiagnostic;\n\n  return {\n    line: start.line,\n    column: start.column,\n    endLine: end.line,\n    endColumn: end.column,\n    start: startPos,\n    end: endPos,\n    type: 'StrictModeError',\n    // expect strict options to always present\n    severity: ProblemSeverity.ERROR,\n    problem: FaultID[faultId],\n    suggest: messageText,\n    rule: messageText,\n    ruleTag: faultsAttrs[faultId] ? faultsAttrs[faultId].cookBookRef : 0\n  };\n}\n\n/**\n * Returns line and column of the position, counts from 1\n */\nfunction getLineAndColumn(file: ts.SourceFile, position: number): { line: number; column: number } {\n  const { line, character } = file.getLineAndCharacterOfPosition(position);\n  // TSC counts lines and columns from zero\n  return {\n    line: line + 1,\n    column: character + 1\n  };\n}\n"],"mappings":"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","ignoreList":[]}